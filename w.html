<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuneScope - Your Musical Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* ... (Keep your original styles here) ... */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
            padding-top: 50px; /* Space for the fixed nav bar */
        }
        .gradient-text {
            background-image: linear-gradient(to right, #f97316, #facc15);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
        .animate-marquee {
            animation: marquee 15s linear infinite;
            width: 100%;
        }
        .animate-marquee2 {
            animation: marquee2 25s linear infinite;
        }
        @keyframes marquee {
          0% { transform: translateX(100%); }
          100% { transform: translateX(-100%); }
        }
        @keyframes marquee2 {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(100%); }
        }

        /* Sidebar specific styles */
        .sidebar {
            width: 280px; /* Fixed width for the sidebar */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100; /* Ensure it's above other content */
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .backdrop {
            display: none;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 90; /* Below sidebar, above content */
        }
        .backdrop.open {
            display: block;
        }
        
        /* New Profile styles */
        .profile-container {
            background-color: #282828;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            margin: 0 auto;
        }
        .profile-input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #1c1c1c;
            color: #e0e0e0;
            box-sizing: border-box;
        }

        /* Top-Right Username Display */
        #user-display-name {
            position: absolute;
            top: 25px;
            right: 25px;
            padding: 8px 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: #facc15;
            background-color: #282828;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            letter-spacing: 0.5px;
            transition: opacity 0.3s;
        }

        /* NEW TOP NAV BAR STYLES */
        #top-nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #0f0f0f;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        .nav-button {
            padding: 8px 15px;
            font-size: 1em;
            font-weight: 600;
            border: 1px solid #d4af37;
            border-radius: 6px;
            background-color: #282828;
            color: #d4af37;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .nav-button:hover {
            background-color: #d4af37;
            color: #1c1c1c;
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-100 antialiased">
    
    <!-- NEW: Fixed Top Navigation Bar (Hidden on this page as sidebar handles home) -->
    <div id="top-nav-bar" style="display:none;"></div>

    <div id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-stone-900 shadow-xl p-6 flex flex-col">
        <div class="flex justify-end mb-8">
            <button id="close-sidebar" class="text-stone-400 hover:text-white focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <nav class="flex-grow">
            <ul class="space-y-4">
                <li>
                    <!-- Home link added to sidebar -->
                    <a href="w.html" class="flex items-center gap-3 p-3 rounded-lg text-stone-300 hover:bg-stone-800 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        Home (Dashboard)
                    </a>
                </li>
                <li>
                    <a href="#" id="user-profile-link" class="flex items-center gap-3 p-3 rounded-lg text-stone-300 hover:bg-stone-800 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        User Profile
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center gap-3 p-3 rounded-lg text-stone-300 hover:bg-stone-800 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                        Progress
                    </a>
                </li>
                <li id="login-link-container" style="display:none;">
                    <a href="login.html" class="flex items-center gap-3 p-3 rounded-lg text-stone-300 hover:bg-stone-800 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                        Login
                    </a>
                </li>
                <li id="signup-link-container" style="display:none;">
                    <a href="signup.html" class="flex items-center gap-3 p-3 rounded-lg text-stone-300 hover:bg-stone-800 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                        Sign Up
                    </a>
                </li>
                <li>
                    <button id="theme-toggle" class="flex items-center gap-3 p-3 rounded-lg text-stone-300 hover:bg-stone-800 hover:text-white transition-colors duration-200 w-full text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun-moon"><path d="M12 8a2.83 2.83 0 0 0 4 4 4.95 4.95 0 0 1-1.45 3.55A4 4 0 0 1 8 12a4.95 4.95 0 0 1 3.55-1.45A2.83 2.83 0 0 0 12 8Z"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M22 12h-2"/><path d="M4 12H2"/><path d="M19.78 4.22 18.36 5.64"/><path d="M5.64 18.36 4.22 19.78"/><path d="M18.36 18.36 19.78 19.78"/><path d="M4.22 4.22 5.64 5.64"/></svg>
                        Theme
                    </button>
                </li>
                <li id="logout-link-container" style="display:none;">
                    <button id="logout-button" class="flex items-center gap-3 p-3 rounded-lg text-stone-300 hover:bg-stone-800 hover:text-white transition-colors duration-200 w-full text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                        Logout
                    </button>
                </li>
            </ul>
        </nav>
    </div>

    <div id="backdrop" class="backdrop fixed inset-0"></div>

    <header class="text-center pt-12 md:pt-20 mb-10">
        <div class="container mx-auto px-4 relative">
            <button id="open-sidebar" class="absolute top-0 left-4 text-stone-300 hover:text-white focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
            
            <!-- Username Display -->
            <span id="user-display-name" style="opacity:0;">--</span>
            
            <h1 id="main-title" class="text-4xl md:text-6xl font-bold gradient-text mb-2">
                Welcome to TuneScope
            </h1>
        </div>
        <div id="dashboard-subtitle" class="container mx-auto px-4">
            <p class="text-lg md:text-xl text-stone-400 max-w-3xl mx-auto">
                Your all-in-one digital toolkit for musicians. Sharpen your skills, practice with precision, and record your ideas.
            </p>
        </div>
        <div class="relative flex overflow-x-hidden text-amber-400/80 mt-4 mb-4 w-full">
            <div class="py-2 animate-marquee whitespace-nowrap">
                <span class="text-2xl mx-4">♪</span><span class="text-2xl mx-4">♫</span><span class="text-2xl mx-4">♬</span><span class="text-2xl mx-4">♭</span><span class="text-2xl mx-4">♮</span><span class="text-2xl mx-4">♯</span><span class="text-2xl mx-4">♪</span><span class="text-2xl mx-4">♫</span><span class="text-2xl mx-4">♬</span><span class="text-2xl mx-4">♭</span><span class="text-2xl mx-4">♮</span><span class="text-2xl mx-4">♯</span>
            </div>
        </div>
    </header>

    <div id="main-content" class="container mx-auto px-4 pb-12 md:pb-20">
        <nav class="container mx-auto px-4 mb-10 text-center max-w-4xl">
            <a href="tut.html" class="block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                <div class="flex items-center gap-6">
                    <div class="text-amber-400"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg></div>
                    <div class="text-left">
                        <h2 class="text-xl font-semibold text-white mb-1">Tutorials</h2>
                        <p class="text-stone-400">Learn how to use TuneScope's features.</p>
                    </div>
                </div>
            </a>
        </nav>
        
        <main>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <a href="pitch.html" class="block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    <div class="flex items-center gap-6">
                        <div class="text-amber-400"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                        <div>
                            <h2 class="text-xl font-semibold text-white mb-1">Tone Recognition</h2>
                            <p class="text-stone-400">Identify musical notes in real-time.</p>
                        </div>
                    </div>
                </a>
                <a href="scale.html" class="block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    <div class="flex items-center gap-6">
                        <div class="text-amber-400"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10c0-4.42-2.87-8.17-7-9.54"/><path d="M12 2v20"/><path d="m22 12-5.6-1.4L15 5l-1.4 5.6L8 12l5.6 1.4L15 19l1.4-5.6Z"/></svg></div>
                        <div>
                            <h2 class="text-xl font-semibold text-white mb-1">Scale Identification</h2>
                            <p class="text-stone-400">Discover the scale of a melody.</p>
                        </div>
                    </div>
                </a>
                <a href="tuner.html" class="block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    <div class="flex items-center gap-6">
                        <div class="text-amber-400"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gauge"><path d="m12 14 4-4"/><path d="M3.34 19.16a10 10 0 1 1 17.32 0"/><path d="M9.76 21.66 8 22 7 18 9.76 21.66Z"/><path d="M14.34 21.66 16 22l1-4-2.66 3.66Z"/></svg></div>
                        <div>
                            <h2 class="text-xl font-semibold text-white mb-1">Tuner</h2>
                            <p class="text-stone-400">Tune your instrument with precision.</p>
                        </div>
                    </div>
                </a>
                <a href="metronome.html" class="block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    <div class="flex items-center gap-6">
                        <div class="text-amber-400"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.5 2-19 19"/><path d="M10.2 2.2 4.5 8.4"/><path d="m15.5 7.7 5.7 5.8"/><path d="m11.6 12.8 5.8 5.7"/><path d="m3.8 8.4 7.8 7.8"/></svg></div>
                        <div>
                            <h2 class="text-xl font-semibold text-white mb-1">Metronome</h2>
                            <p class="text-stone-400">Keep perfect time with precision.</p>
                        </div>
                    </div>
                </a>
                <a href="record.html" class="block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    <div class="flex items-center gap-6">
                        <div class="text-amber-400"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></div>
                        <div>
                            <h2 class="text-xl font-semibold text-white mb-1">Audio Recorder</h2>
                            <p class="text-stone-400">Capture your musical ideas.</p>
                        </div>
                    </div>
                </a>
                <a href="analyzer.html" class="block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    <div class="flex items-center gap-6">
                        <div class="text-amber-400"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg></div>
                        <div>
                            <h2 class="text-xl font-semibold text-white mb-1">Audio Analyzer</h2>
                            <p class="text-stone-400">Analyze notes and scales from recordings.</p>
                        </div>
                    </div>
                </a>
            </div>

            <section class="mt-24">
                <div class="bg-gradient-to-br from-amber-900/50 to-orange-900/50 p-8 rounded-2xl border border-amber-500/50 shadow-2xl shadow-amber-500/10 overflow-hidden">
                    <div class="flex flex-col md:flex-row items-center justify-center gap-8">
                        <div class="md:w-1/3">
                            <img src="https://placehold.co/600x600/292524/f59e0b/png?text=ACOUSTIC%0ASHOWCASE&font=playfair" 
                                 alt="Acoustic Showcase Poster"
                                 class="rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300">
                        </div>
                        <div class="md:w-2/3 text-center md:text-left">
                             <h2 class="text-3xl font-bold text-white mb-2 font-playfair">Featured Event: Acoustic Showcase</h2>
                             <p class="text-amber-200 mb-6">Open Mic Night</p>
                            <p class="text-stone-300 max-w-2xl mb-6">
                                Share your original songs or favorite covers! Join us for a cozy evening of live music on **September 15th, 2025**. Sign-ups are open now. All are welcome to perform or listen!
                            </p>
                            <a href="#" class="inline-block bg-amber-500 text-stone-900 font-bold py-3 px-8 rounded-lg hover:bg-amber-600 transition-colors shadow-md hover:shadow-lg hover:shadow-amber-400/40">Sign Up to Perform</a>
                        </div>
                     </div>
                </div>
            </section>

            <section class="mt-24 text-center">
                <h2 class="text-3xl font-bold text-white mb-4">Why Choose TuneScope?</h2>
                <p class="text-lg text-stone-400 max-w-3xl mx-auto mb-12">
                    We built TuneScope with one goal: to provide powerful, easy-to-use tools that help you grow as a musician.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                    <div class="bg-stone-900/50 p-6 rounded-lg"><h3 class="text-xl font-semibold text-amber-400 mb-2">Precision & Accuracy</h3><p class="text-stone-400">Our algorithms are finely tuned to give you reliable results, whether you're tuning an instrument or analyzing a complex melody.</p></div>
                    <div class="bg-stone-900/50 p-6 rounded-lg"><h3 class="text-xl font-semibold text-orange-400 mb-2">All-In-One Convenience</h3><p class="text-stone-400">No more switching between apps. From ear training to time-keeping, everything you need for practice is right here.</p></div>
                    <div class="bg-stone-900/50 p-6 rounded-lg"><h3 class="text-xl font-semibold text-yellow-400 mb-2">Free & Accessible</h3><p class="text-stone-400">TuneScope is free to use on any device with a web browser. Start practicing instantly, with no downloads required.</p></div>
                </div>
            </section>
            
            <section class="mt-24 text-center">
                <h2 class="text-3xl font-bold text-white mb-12">What Musicians Are Saying</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-stone-900/50 p-6 rounded-lg text-left flex flex-col"><p class="text-stone-300 italic flex-grow">"The tone recognition is incredibly fast and accurate. It's become an essential part of my daily transcription practice."</p><div class="flex items-center justify-end mt-4"><p class="text-amber-400 font-semibold mr-3">- Alex R., Guitarist</p><img src="https://placehold.co/40x40/f59e0b/1c1917?text=A" class="rounded-full"></div></div>
                    <div class="bg-stone-900/50 p-6 rounded-lg text-left flex flex-col"><p class="text-stone-300 italic flex-grow">"I love the metronome. It's simple, stable, and the tap tempo feature is a lifesaver. Highly recommend!"</p><div class="flex items-center justify-end mt-4"><p class="text-orange-400 font-semibold mr-3">- Maya K., Pianist</p><img src="https://placehold.co/40x40/fb923c/1c1917?text=M" class="rounded-full"></div></div>
                    <div class="bg-stone-900/50 p-6 rounded-lg text-left flex flex-col"><p class="text-stone-300 italic flex-grow">"As a music student, the scale identifier is a fantastic tool for analyzing pieces and improving my theory knowledge."</p><div class="flex items-center justify-end mt-4"><p class="text-yellow-400 font-semibold mr-3">- Ben S., Student</p><img src="https://placehold.co/40x40/facc15/1c1917?text=B" class="rounded-full"></div></div>
                </div>
            </section>

        </main>
    </div> <!-- End of main-content -->
    
    <!-- New User Profile View (Initially hidden) -->
    <div id="profile-content" class="container mx-auto px-4 pb-12 md:pb-20 hidden">
        <div class="profile-container mt-12">
            <h2 class="text-3xl font-bold text-amber-500 mb-6 text-center">Your Profile</h2>
            <div id="profile-info" class="space-y-4">
                <p class="text-stone-300">Email: <span id="profile-email" class="font-semibold text-white">Loading...</span></p>
                <p class="text-stone-300">Current Username: <span id="profile-username" class="font-semibold text-amber-400">None Set</span></p>
                <p class="text-stone-300">Member Since: <span id="profile-member-since" class="font-semibold text-white">Loading...</span></p>
            </div>

            <div id="username-form" class="mt-8 p-6 bg-stone-900/50 rounded-lg border border-stone-700">
                <h3 class="text-xl font-semibold text-white mb-4">Set Your Unique Username</h3>
                <p id="username-status" class="text-sm text-stone-400 mb-4">This username cannot be changed later.</p>
                <input type="text" id="new-username-input" class="profile-input" placeholder="Enter new username (4-15 chars, letters/numbers)">
                <button id="save-username-btn" class="w-full bg-amber-500 text-stone-900 font-bold py-3 px-8 rounded-lg hover:bg-amber-600 transition-colors shadow-md mt-4" disabled>
                    Save Username
                </button>
            </div>
            
            <button id="back-to-dashboard-btn" class="w-full bg-stone-700 text-stone-100 font-bold py-3 px-8 rounded-lg hover:bg-stone-600 transition-colors shadow-md mt-6">
                ← Back to Dashboard
            </button>
        </div>
    </div> <!-- End of profile-content -->
    
    <footer class="text-center mt-24 py-6 border-t border-stone-700">
        <p class="text-stone-500 text-sm">
            This app uses your device's microphone. Results may be affected by background noise.
        </p>
        <p class="text-stone-600 text-xs mt-2">
            &copy; 2025 TuneScope. All Rights Reserved.
        </p>
    </footer>

    <!-- Firebase SDK Imports -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> <!-- Added Firestore -->
    <!-- End Firebase SDK Imports -->

    <script>
        // --- FIREBASE INITIALIZATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAiQ7Dhsih0IWppdwTxfTKLBWXnZ44xHQ0",
          authDomain: "cclproj-42c85.firebaseapp.com",
          projectId: "cclproj-42c85",
          storageBucket: "cclproj-42c85.firebasestorage.app",
          messagingSenderId: "862583513087",
          appId: "1:862583513087:web:7c91157f9c4ee8a97751ca",
          measurementId: "G-QNC4GVHQ47"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); // Initialize Firestore

        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('open-sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const backdrop = document.getElementById('backdrop');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const body = document.body;
        const logoutButton = document.getElementById('logout-button');
        const logoutLinkContainer = document.getElementById('logout-link-container');
        const loginLinkContainer = document.getElementById('login-link-container');
        const signupLinkContainer = document.getElementById('signup-link-container');

        // Main View Controls
        const mainTitle = document.getElementById('main-title');
        const dashboardSubtitle = document.getElementById('dashboard-subtitle');
        const mainContent = document.getElementById('main-content');
        const profileContent = document.getElementById('profile-content');
        const userProfileLink = document.getElementById('user-profile-link');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        
        // Profile Controls
        const profileEmail = document.getElementById('profile-email');
        const profileUsername = document.getElementById('profile-username');
        const profileMemberSince = document.getElementById('profile-member-since');
        const newUsernameInput = document.getElementById('new-username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const usernameStatus = document.getElementById('username-status');
        const usernameForm = document.getElementById('username-form');
        const userDisplayName = document.getElementById('user-display-name');


        // --- UI & STATE FUNCTIONS ---
        
        function formatMemberSince(timestamp) {
            const date = new Date(timestamp);
            const pad = (num) => num.toString().padStart(2, '0');
            const DD = pad(date.getDate());
            const MM = pad(date.getMonth() + 1);
            const YY = date.getFullYear().toString().slice(-2);
            const HH = pad(date.getHours());
            const MI = pad(date.getMinutes());
            
            return `${DD}/${MM}/${YY} ${HH}:${MI}`;
        }

        function setTopRightDisplayName(name) {
            if (name && name !== '') {
                userDisplayName.textContent = name;
                userDisplayName.style.opacity = '1';
            } else {
                userDisplayName.textContent = 'Account';
                userDisplayName.style.opacity = '0.5';
            }
        }
        
        function showView(view) {
            if (view === 'dashboard') {
                profileContent.classList.add('hidden');
                mainContent.classList.remove('hidden');
                mainTitle.textContent = "Welcome to TuneScope";
                dashboardSubtitle.classList.remove('hidden');
            } else if (view === 'profile') {
                mainContent.classList.add('hidden');
                dashboardSubtitle.classList.add('hidden');
                profileContent.classList.remove('hidden');
                mainTitle.textContent = "Your Profile";
                loadUserProfile(auth.currentUser);
            }
        }
        
        userProfileLink.addEventListener('click', (e) => {
            e.preventDefault();
            closeSidebar();
            showView('profile');
        });
        backToDashboardBtn.addEventListener('click', () => {
            showView('dashboard');
        });

        function updateSidebar(user) {
            if (user) {
                // User is signed in. Show Logout, Hide Login/Signup.
                logoutLinkContainer.style.display = 'block';
                loginLinkContainer.style.display = 'none';
                signupLinkContainer.style.display = 'none';
            } else {
                // User is signed out. Show Login/Signup, Hide Logout.
                logoutLinkContainer.style.display = 'none';
                loginLinkContainer.style.display = 'block';
                signupLinkContainer.style.display = 'block';
                // Redirect unauthorized users
                window.location.replace('signup.html');
            }
            setTopRightDisplayName(user ? user.displayName : null);
        }
        
        // --- USERNAME LOGIC ---

        async function loadUserProfile(user) {
            if (!user) return;

            profileEmail.textContent = user.email;
            
            // Set Member Since date from Firebase Auth metadata
            profileMemberSince.textContent = formatMemberSince(user.metadata.creationTime);
            
            if (user.displayName) {
                profileUsername.textContent = user.displayName;
                usernameForm.innerHTML = '<p class="text-green-400 text-lg font-semibold">Username set! It cannot be changed.</p>';
                setTopRightDisplayName(user.displayName);
                return;
            }

            // If displayName is not set, check Firestore for a pending username
            try {
                // Use a direct doc lookup for the user's dedicated document first
                const doc = await db.collection('usernames').doc(user.uid).get();
                if (doc.exists && doc.data().username) {
                    // Update Firebase Auth profile
                    await user.updateProfile({ displayName: doc.data().username });
                    profileUsername.textContent = doc.data().username;
                    setTopRightDisplayName(doc.data().username);
                    usernameForm.innerHTML = '<p class="text-green-400 text-lg font-semibold">Username set! It cannot be changed.</p>';
                } else {
                    profileUsername.textContent = 'None Set';
                    newUsernameInput.disabled = false;
                    saveUsernameBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error loading profile:", error);
                usernameStatus.textContent = "Error loading username data. Check console/Firestore Rules.";
            }
        }

        newUsernameInput.addEventListener('input', () => {
            const username = newUsernameInput.value.trim();
            // Basic validation
            if (username.length >= 4 && username.length <= 15 && /^[a-zA-Z0-9]+$/.test(username)) {
                saveUsernameBtn.disabled = false;
                usernameStatus.textContent = "Looks good! Click save.";
                usernameStatus.classList.remove('text-red-400');
                usernameStatus.classList.add('text-green-400');
            } else {
                saveUsernameBtn.disabled = true;
                usernameStatus.textContent = "Username must be 4-15 characters and contain only letters and numbers.";
                usernameStatus.classList.remove('text-green-400');
                usernameStatus.classList.add('text-red-400');
            }
        });

        saveUsernameBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || user.displayName) return;

            const newUsername = newUsernameInput.value.trim();
            if (newUsername.length < 4 || newUsername.length > 15 || !/^[a-zA-Z0-9]+$/.test(newUsername)) return;
            
            saveUsernameBtn.disabled = true;
            usernameStatus.textContent = 'Checking availability and saving...';

            try {
                // Use a transaction for the most robust uniqueness check and claim
                await db.runTransaction(async (transaction) => {
                    const usernameIndexRef = db.collection('usernameIndex').doc(newUsername.toLowerCase());
                    const usernameIndexDoc = await transaction.get(usernameIndexRef);

                    // 1. Check for uniqueness
                    if (usernameIndexDoc.exists) {
                        throw new Error('Username is already taken'); // Throw to roll back and handle error
                    }
                    
                    // 2. Claim the username in the index
                    transaction.set(usernameIndexRef, {
                        username: newUsername.toLowerCase(),
                        uid: user.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 3. Save metadata to user's dedicated document
                    transaction.set(db.collection('usernames').doc(user.uid), {
                        username: newUsername,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                // 4. Update Firebase Auth profile outside the transaction
                await user.updateProfile({ displayName: newUsername });

                // Success UI update
                usernameStatus.textContent = '✅ Username saved permanently!';
                usernameStatus.classList.remove('text-red-400');
                usernameStatus.classList.add('text-green-400');
                profileUsername.textContent = newUsername;
                setTopRightDisplayName(newUsername);
                usernameForm.innerHTML = '<p class="text-green-400 text-lg font-semibold">Username set! It cannot be changed.</p>';

            } catch (error) {
                console.error("Error setting username:", error);
                
                // Handle the specific 'already taken' error from the transaction or general failure
                if (error.message && error.message.includes('already taken')) {
                    usernameStatus.textContent = '❌ Username is already taken!';
                } else if (error.code) { // Firebase errors have codes
                    usernameStatus.textContent = `⚠️ Firebase Error: ${error.code}. Check console/Firestore Rules.`;
                } else {
                    usernameStatus.textContent = '⚠️ An unknown error occurred during saving. Try again.';
                }
                
                usernameStatus.classList.remove('text-green-400');
                usernameStatus.classList.add('text-red-400');
                saveUsernameBtn.disabled = false;
            }
        });

        // --- AUTH & SIDEBAR FUNCTIONS ---

        async function handleLogout() {
            try {
                await auth.signOut();
                // Redirection handled by onAuthStateChanged
            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to log out.');
            }
        }

        logoutButton.addEventListener('click', handleLogout);

        // Firebase Auth State Listener (Checks authentication on load)
        auth.onAuthStateChanged((user) => {
            updateSidebar(user);
            if (user) {
                // Check user profile data upon logging in
                loadUserProfile(user); 
            }
        });
        
        // --- UI UTILITIES ---

        function openSidebar() {
            sidebar.classList.add('open');
            backdrop.classList.add('open');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            backdrop.classList.remove('open');
        }

        openSidebarBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        backdrop.addEventListener('click', closeSidebar);

        themeToggleBtn.addEventListener('click', () => {
            if (body.classList.contains('bg-stone-950')) {
                body.classList.remove('bg-stone-950', 'text-stone-100');
                body.classList.add('bg-stone-100', 'text-stone-950');
            } else {
                body.classList.remove('bg-stone-100', 'text-stone-950');
                body.classList.add('bg-stone-950', 'text-stone-100');
            }
        });
    </script>
</body>
</html>
